# Project Context & Next Steps üéØ

**Last Updated:** Feb 23, 2026

---

## ‚úÖ WHERE WE ARE NOW (Current State)

The SaaS CRM has reached production-grade maturity, completing a deep refactoring phase to solidify multi-tenant RBAC, secure server-side data fetching, and an entirely interactive drag-and-drop Kanban pipeline.

### Core Achievements This Session
- ‚úÖ **Server-Side API Bypass** for critical Super Admin views: `/api/sa/admins`, `/api/sa/universities`, and `/api/sa/subscriptions` all now securely authenticate the user and bypass RLS caching using the Supabase Service Role key, guaranteeing 100% accurate, live metrics without dummy placeholders.
- ‚úÖ **Interactive Drag & Drop Kanban** (`@dnd-kit`): Upgraded `/u/kanban` and `/agent/kanban` from read-only boards to fully interactive drag-and-drop interfaces with optimistic UI persistence updating Lead statuses directly in Postgres.
- ‚úÖ **Dual-Mode Agent Provisioning**: Completely refactored the failing Agent Edge Function. Agents can now be provisioned securely via `/api/agents/create` using either **Email Magic Links** or **Manual Password Generation**.
- ‚úÖ **Agent RLS Resolution**: Agent data access is strictly enforced. The `/agent/leads` dashboard purely mirrors assigned leads using dynamic, RLS-enforced queries instead of dummy data.
- ‚úÖ **Lead Enrichment & UI**: Added deep "Lead Details" side panels, unified table filtering by Program/Stage, and successfully migrated a new `score` column to the `leads` table. Program Cards now show live numeric statistics.

### Database (Supabase)
- ‚úÖ **12 active tables**: `universities`, `profiles`, `agents`, `leads`, `kanban_stages`, `departments`, `programs`, `forms`, `settings`, `subscriptions`, `messages`, `audit_logs`
- ‚úÖ **Role ENUM enforced**: `super_admin`, `university_admin`, `agent`, `public`
- ‚úÖ **Advanced RLS policies** isolating tenant data at an atomic level.

### Frontend (Next.js 16, App Router)
Completely segregated into 3 distinct authenticated portals:
1. `/sa/*` (Platform Super Admin): Manages all Universities, subscriptions logic, and cross-platform analytics.
2. `/u/*` (University Tenant Admin): Controls institutional leads, agent provisioning, kanban customization, and branding.
3. `/agent/*` (Assigned Agents): Processes incoming leads specific to their own queue and advances them through the funnel.

---

## üî¥ WHAT STILL NEEDS DOING (Tomorrow's Goals)

### Must Do Before Full Launch
1. **Platform Notifications & Email Workflows (`/agent/communication`)**
   - Implement the actual SendGrid/Postmark integration to allow Agents to send outbound emails directly from the Lead Details panel.
   - Set up Supabase DB Webhooks to trigger "New Lead Assigned" email alerts to agents based on the `settings.communication` preferences.
2. **Subscriptions & Stripe Billing Gateway (`/sa/subscriptions`)**
   - Connect the Super Admin platform's computed active tenants/MRR metrics to a live Stripe Checkout API flow to handle real University onboarding paywalls and tier limits (e.g., max agents).
3. **Advanced Analytics Dashboards (`/sa/analytics` & `/u/dashboard`)**
   - Now that `leads.score` and custom kanban stages hold real data, wire up the `recharts` components to display live conversion funnels, average time-in-stage, and agent performance metrics.
4. **End-to-End Testing & Polish**
   - Run a strict QA sweep of an organic public signup -> form submission -> kanban conversion -> audit log trace to ensure zero regression across the 3 portals.

---

## üêõ Known Bugs Patched This Session
- **Blank SA Admins Table:** Database RLS cache hid the `profiles` table even from Super Admins. Solved via SSR Server Client and `SUPABASE_SERVICE_ROLE_KEY` bypass on Next.js API endpoints.
- **Agent Invite "Unauthorized" Error:** Discarded failing unconfigured Edge Function in favor of local Next.js `/api/agents/create` API route correctly parsing `cookies` using `@supabase/ssr`.
- **Kanban Render Bugs:** Enforced exact client-side dimensions with `dnd-kit` to prevent layout shift during fluid drag animations.
- **Kanban Drop Rejection:** Migrated `@dnd-kit/sortable` temporary IDs from `Date.now()` to strict `crypto.randomUUID()` strings, preventing drag contexts from losing their references on unpersisted stages.
- **Settings API 406 Error:** Upgraded `settings` table data fetching from strict `.single()` to graceful `.limit(1)` with optional chaining across all layout and settings panels, preventing Edge Cache errors when new tenants log in before configuring branding.
