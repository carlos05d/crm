# Project Context & Next Steps üéØ

**Last Updated:** Feb 22, 2026 ‚Äî Session 2 Complete

---

## ‚úÖ WHERE WE ARE NOW (Current State)

The **full Mega Prompt spec** has been implemented. This is a production-grade multi-tenant University SaaS CRM.

### Database (Supabase)
- ‚úÖ **12 tables** live: `universities`, `profiles`, `agents`, `leads`, `kanban_stages`, `departments`, `programs`, `forms`, `settings`, `subscriptions`, `messages`, `audit_logs`
- ‚úÖ `profiles.role` upgraded to a **Postgres ENUM** (`super_admin`, `university_admin`, `agent`, `public`)
- ‚úÖ **30+ RLS policies** enforcing strict tenant isolation and role-based access
- ‚úÖ All migrations applied ‚Äî `20260101`, `20260102`, `20260222` all succeeded

### Edge Functions (Supabase ‚Äî already deployed)
- ‚úÖ `provisionAgent` ‚Äî invites user, creates profile + agent row, bootstraps Kanban stages, writes audit log
- ‚úÖ `sendEmail` ‚Äî SMTP relay via settings table, logs to messages
- ‚úÖ `sendWhatsApp` ‚Äî Meta API, logs to messages

### Frontend (Next.js 16, App Router)
Full **35-route application** with **3 completely separate portals**:

| Portal | Layout | Key Pages |
|--------|--------|-----------|
| `/sa/*` | Super Admin | dashboard, universities, universities/[id], admins, subscriptions, analytics, audit-logs, **settings** |
| `/u/*` | Tenant Admin | dashboard, leads, kanban, agents, forms, academics/departments, **academics/programs**, communication, **settings/branding**, reports, **audit-logs** |
| `/agent/*` | Agent Staff | dashboard, leads, **kanban (dnd-kit drag-drop)**, communication, **settings**, **activity** |
| `/forms/*` | Public | [universitySlug]/[formSlug] |

### UI Components (18 total)
`avatar`, `badge`, `button`, `card`, `dialog`, `dropdown-menu`, `form`, `input`, `label`, `scroll-area`, `select`, `separator`, `skeleton`, `switch`, `table`, `tabs`, `textarea`, `toast-provider`

### Key Features Working
- ‚úÖ **dnd-kit drag-and-drop Kanban** with Supabase persistence (optimistic UI)
- ‚úÖ **Zod + React Hook Form** validation on lead creation
- ‚úÖ **Global toast notifications** (`useToast()` hook)
- ‚úÖ **CSV export reports** for leads, agents, messages
- ‚úÖ **Role-based routing middleware** ‚Äî logs in to correct portal automatically
- ‚úÖ **Audit log timeline** on U admin and Agent activity pages
- ‚úÖ **Branding settings** with live color pickers

---

## üî¥ WHAT STILL NEEDS DOING (Next Session)

### Must Do Before Full Production
1. **Test login flow end-to-end**
   - Create user in Supabase Auth dashboard
   - Run: `UPDATE profiles SET role = 'super_admin' WHERE email = 'x@x.com';`
   - Visit `localhost:3000/login` ‚Äî should auto-redirect to `/sa/dashboard`

2. **Wire Edge Function secrets** in Supabase dashboard ‚Üí Settings ‚Üí Edge Functions:
   - `SUPABASE_SERVICE_ROLE_KEY`
   - For `sendEmail`: `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS`
   - For `sendWhatsApp`: `META_WHATSAPP_TOKEN`, `META_PHONE_NUMBER_ID`

3. **Profile auto-creation trigger** ‚Äî currently `profiles` row must be inserted manually or via signup action. Consider adding a Postgres trigger:
   ```sql
   CREATE OR REPLACE FUNCTION handle_new_user() RETURNS trigger AS $$
   BEGIN
     INSERT INTO public.profiles (id, email, role)
     VALUES (new.id, new.email, 'agent')
     ON CONFLICT DO NOTHING;
     RETURN new;
   END;
   $$ LANGUAGE plpgsql SECURITY DEFINER;

   CREATE TRIGGER on_auth_user_created
     AFTER INSERT ON auth.users
     FOR EACH ROW EXECUTE FUNCTION handle_new_user();
   ```

4. **U/Kanban page** ‚Äî currently copied from agent kanban; give University Admin a read-only overview board

5. **Agent Forms page** (`/agent/forms`) ‚Äî not yet built; can be a simple read-only view of form submissions assigned to the agent

### Nice To Have
- Realtime updates on Kanban when lead moves (Supabase channel subscription)
- Pagination on Leads table (currently loads all)
- Email invite flow UI on `/u/agents` (currently uses Edge Function directly)
- Mobile responsive sidebar (hamburger menu)

---

## üêõ Known Issues Fixed This Session
- `ALTER COLUMN role TYPE` migration error ‚Üí fixed by dropping all policies first
- `createContext only works in Client Components` ‚Üí added `"use client"` to toast-provider
- `ERR_TOO_MANY_REDIRECTS` ‚Üí middleware was redirecting to `/` instead of `/login` for unauthenticated users

---

## üóÇ Key Files Reference

| File | Purpose |
|------|---------|
| `src/middleware.ts` | Role-based route guards + login redirects |
| `src/app/(auth)/login/actions.ts` | Login server action + role-based redirect |
| `supabase/migrations/20260222000000_v2_mega_schema.sql` | **THE** V2 schema ‚Äî all tables, RLS, indexes |
| `supabase/functions/provisionAgent/index.ts` | Agent auto-provisioning Edge Function |
| `src/components/ui/toast-provider.tsx` | Global toast system |
| `src/app/agent/kanban/page.tsx` | dnd-kit drag-drop kanban |
| `src/app/u/leads/page.tsx` | Full leads CRUD with Zod + agent assignment |

---

*Good night! Everything is committed and pushed. When you return, start with "Test login flow" above. The hard work is done ‚Äî this is a complete SaaS. üöÄ*
